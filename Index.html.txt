<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Code Grabber</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #111827;
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .header {
      background: #1f2937;
      border-bottom: 1px solid #374151;
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-info h1 { font-size: 1.25rem; font-weight: bold; }
    .header-info p { font-size: 0.875rem; color: #9ca3af; margin-top: 0.25rem; }
    .cam-btn {
      background: #2563eb;
      border: none;
      color: white;
      padding: 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1.5rem;
      line-height: 1;
    }
    .cam-btn:hover { background: #1d4ed8; }
    .scanner-view {
      position: fixed;
      inset: 0;
      background: black;
      z-index: 50;
      display: none;
      flex-direction: column;
    }
    .scanner-view.active { display: flex; }
    .video-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .scan-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .scan-frame {
      border: 4px solid #3b82f6;
      width: 16rem;
      height: 16rem;
      border-radius: 0.5rem;
    }
    .scanner-controls {
      background: #1f2937;
      padding: 1rem;
    }
    .scanner-controls p {
      font-size: 0.875rem;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 0.75rem;
    }
    .input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .input-group input {
      flex: 1;
      background: #374151;
      border: 1px solid #4b5563;
      border-radius: 0.25rem;
      padding: 0.5rem 0.75rem;
      color: white;
      font-size: 1rem;
    }
    .btn {
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-weight: 500;
      font-size: 1rem;
    }
    .btn-add { background: #16a34a; color: white; }
    .btn-add:hover { background: #15803d; }
    .btn-cancel { background: #dc2626; color: white; width: 100%; }
    .btn-cancel:hover { background: #b91c1c; }
    .action-bar {
      background: #1f2937;
      border-bottom: 1px solid #374151;
      padding: 0.75rem;
      position: sticky;
      top: 4.5rem;
      z-index: 10;
      display: none;
      gap: 0.5rem;
      justify-content: center;
    }
    .action-bar.active { display: flex; }
    .btn-action {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #374151;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
    }
    .btn-action:hover { background: #4b5563; }
    .btn-action:disabled { background: #374151; opacity: 0.5; cursor: not-allowed; }
    .btn-clear { background: #dc2626; }
    .btn-clear:hover { background: #b91c1c; }
    .btn-clear:disabled { background: #991b1b; }
    .grid {
      padding: 1rem;
      max-width: 80rem;
      margin: 0 auto;
      display: grid;
      gap: 1rem;
      grid-template-columns: 1fr;
    }
    @media (min-width: 640px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 1024px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
    }
    .empty-state {
      text-align: center;
      padding: 4rem 1rem;
      color: #6b7280;
    }
    .empty-state svg {
      width: 4rem;
      height: 4rem;
      margin: 0 auto 1rem;
      opacity: 0.5;
    }
    .code-card {
      background: #1f2937;
      border: 2px solid #374151;
      border-radius: 0.5rem;
      padding: 0.75rem;
      position: relative;
      transition: all 0.2s;
    }
    .code-card.selected {
      border-color: #3b82f6;
      background: #1e3a5f;
    }
    .checkbox {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      z-index: 10;
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid #4b5563;
      background: #374151;
      border-radius: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .checkbox.checked {
      background: #2563eb;
      border-color: #2563eb;
    }
    .barcode-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 1.5rem;
    }
    .barcode-wrapper {
      background: white;
      padding: 0.5rem;
      border-radius: 0.25rem;
    }
    canvas { display: block; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-info">
      <h1>Code Grabber</h1>
      <p id="count">0 codes collected</p>
    </div>
    <button class="cam-btn" onclick="toggleScanner()">ðŸ“·</button>
  </div>

  <div class="scanner-view" id="scanner">
    <div class="video-container">
      <video id="video" playsinline autoplay muted></video>
      <div class="scan-overlay">
        <div class="scan-frame"></div>
      </div>
    </div>
    <div class="scanner-controls">
      <p>Enter bin ID or barcode</p>
      <div class="input-group">
        <input type="text" id="codeInput" placeholder="e.g., P-8-M866H750">
        <button class="btn btn-add" onclick="addCode()">Add</button>
      </div>
      <button class="btn btn-cancel" onclick="stopScanner()">Cancel</button>
    </div>
  </div>

  <div class="action-bar" id="actionBar">
    <button class="btn-action" onclick="selectAll()" id="selectAllBtn">
      <span>âœ“</span> Select All
    </button>
    <button class="btn-action btn-clear" onclick="clearSelected()" id="clearBtn">
      <span>ðŸ—‘</span> Clear Selected (<span id="selectedCount">0</span>)
    </button>
  </div>

  <div id="content"></div>

  <script>
    let codes = [];
    let selected = new Set();
    let stream = null;

    function updateUI() {
      const count = document.getElementById('count');
      const actionBar = document.getElementById('actionBar');
      const content = document.getElementById('content');
      const selectedCount = document.getElementById('selectedCount');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const clearBtn = document.getElementById('clearBtn');

      count.textContent = `${codes.length} codes collected`;
      selectedCount.textContent = selected.size;
      actionBar.className = codes.length > 0 ? 'action-bar active' : 'action-bar';
      selectAllBtn.disabled = selected.size === codes.length;
      clearBtn.disabled = selected.size === 0;

      if (codes.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <p style="font-size: 1.125rem;">No codes collected yet</p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem;">Tap the camera icon to start scanning</p>
          </div>
        `;
      } else {
        const grid = document.createElement('div');
        grid.className = 'grid';
        codes.forEach(code => {
          const card = document.createElement('div');
          card.className = `code-card ${selected.has(code.id) ? 'selected' : ''}`;
          card.innerHTML = `
            <div class="checkbox ${selected.has(code.id) ? 'checked' : ''}" onclick="toggleSelect(${code.id})">
              ${selected.has(code.id) ? 'âœ“' : ''}
            </div>
            <div class="barcode-container">
              <div class="barcode-wrapper">
                <canvas id="canvas-${code.id}"></canvas>
              </div>
            </div>
          `;
          grid.appendChild(card);
        });
        content.innerHTML = '';
        content.appendChild(grid);

        // Draw barcodes
        setTimeout(() => {
          codes.forEach(code => drawBarcode(code.id, code.data));
        }, 0);
      }
    }

    function drawBarcode(id, data) {
      const canvas = document.getElementById(`canvas-${id}`);
      if (!canvas) return;

      const width = 240;
      const height = 100;
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');

      const patterns = {
        '0':'11011001100','1':'11001101100','2':'11001100110','3':'10010011000',
        '4':'10010001100','5':'10001001100','6':'10011001000','7':'10011000100',
        '8':'10001100100','9':'11001001000','A':'11001000100','B':'11000100100',
        'C':'10110011100','D':'10011011100','E':'10011001110','F':'10111001000',
        'G':'10011101000','H':'10011100010','I':'11001110010','J':'11001011100',
        'K':'11001001110','L':'11011100100','M':'11001110100','N':'11101101110',
        'O':'11101001100','P':'11100101100','Q':'11100100110','R':'11101100100',
        'S':'11100110100','T':'11100110010','U':'11011011000','V':'11011000110',
        'W':'11000110110','X':'10100011000','Y':'10001011000','Z':'10001000110',
        ' ':'10110001000','-':'10001101000','.':'10001100010','START_B':'11010010000',
        'STOP':'1100011101011'
      };

      const charToValue = {' ':0,'!':1,'"':2,'#':3,'$':4,'%':5,'&':6,"'":7,'(':8,')':9,'*':10,'+':11,',':12,'-':13,'.':14,'/':15,'0':16,'1':17,'2':18,'3':19,'4':20,'5':21,'6':22,'7':23,'8':24,'9':25,':':26,';':27,'<':28,'=':29,'>':30,'?':31,'@':32,'A':33,'B':34,'C':35,'D':36,'E':37,'F':38,'G':39,'H':40,'I':41,'J':42,'K':43,'L':44,'M':45,'N':46,'O':47,'P':48,'Q':49,'R':50,'S':51,'T':52,'U':53,'V':54,'W':55,'X':56,'Y':57,'Z':58,'[':59,'\\':60,']':61,'^':62,'_':63};

      let pattern = patterns.START_B;
      let checksum = 104;

      for (let i = 0; i < data.length; i++) {
        const char = data[i];
        const value = charToValue[char] || 0;
        const key = char.toUpperCase();
        if (patterns[key] || patterns[char]) {
          pattern += patterns[key] || patterns[char];
          checksum += value * (i + 1);
        }
      }

      checksum = checksum % 103;
      const checksumChar = Object.keys(charToValue).find(k => charToValue[k] === checksum) || '0';
      pattern += patterns[checksumChar.toUpperCase()] || patterns['0'];
      pattern += patterns.STOP;

      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, width, height);

      const barWidth = width / pattern.length;
      let x = 0;

      ctx.fillStyle = '#000000';
      for (let i = 0; i < pattern.length; i++) {
        if (pattern[i] === '1') {
          ctx.fillRect(x, 0, barWidth, height * 0.85);
        }
        x += barWidth;
      }

      ctx.fillStyle = '#000000';
      ctx.font = '12px monospace';
      ctx.textAlign = 'center';
      ctx.fillText(data, width / 2, height * 0.95);
    }

    async function toggleScanner() {
      const scanner = document.getElementById('scanner');
      if (scanner.classList.contains('active')) {
        stopScanner();
      } else {
        scanner.classList.add('active');
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' },
            audio: false
          });
          document.getElementById('video').srcObject = stream;
        } catch (err) {
          console.error('Camera error:', err);
          alert('Camera access denied. You can still enter codes manually.');
        }
      }
    }

    function stopScanner() {
      const scanner = document.getElementById('scanner');
      scanner.classList.remove('active');
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      document.getElementById('codeInput').value = '';
    }

    function addCode() {
      const input = document.getElementById('codeInput');
      const value = input.value.trim();
      if (value) {
        codes.push({
          id: Date.now(),
          data: value,
          timestamp: new Date().toISOString()
        });
        input.value = '';
        stopScanner();
        updateUI();
      }
    }

    function toggleSelect(id) {
      if (selected.has(id)) {
        selected.delete(id);
      } else {
        selected.add(id);
      }
      updateUI();
    }

    function selectAll() {
      selected = new Set(codes.map(c => c.id));
      updateUI();
    }

    function clearSelected() {
      codes = codes.filter(c => !selected.has(c.id));
      selected.clear();
      updateUI();
    }

    // Handle Enter key in input
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('codeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addCode();
      });
      updateUI();
    });
  </script>
</body>
</html>